<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Air Mouse - Vision Pro Style</title>
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #0f0f0f; color: white; overflow-y: auto; overflow-x: hidden; height: 200vh; }
        
        /* Contenido largo para probar el Scroll */
        #web-content {
            padding: 40px;
            display: flex; flex-direction: column; align-items: center; gap: 30px;
            position: relative; z-index: 1;
        }

        .card {
            width: 80%; max-width: 500px; padding: 30px;
            background: rgba(255,255,255,0.05); border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s;
        }
        .card.hover { background: rgba(0, 255, 204, 0.15); border-color: #00ffcc; transform: scale(1.02); }

        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        #input_video { position: fixed; bottom: 10px; right: 10px; width: 120px; border-radius: 10px; transform: scaleX(-1); opacity: 0.5; }
        
        #hud {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 10px 20px; background: rgba(0,0,0,0.8); border-radius: 30px;
            border: 1px solid #00ffcc; color: #00ffcc; font-weight: bold; z-index: 100;
        }
    </style>
</head>
<body>

    <div id="hud">üñêÔ∏è MUESTRA TU MANO</div>

    <div id="web-content">
        <h1>Vision Air Control</h1>
        <div class="card" onclick="alert('Card 1')"><h3>Elemento 1</h3><p>Haz pellizco para clicar.</p></div>
        <div class="card" onclick="alert('Card 2')"><h3>Elemento 2</h3><p>Mant√©n y mueve para SCROLL.</p></div>
        <div class="card"><h3>Elemento 3</h3><p>Pellizco con dedo MEDIO para Click Derecho.</p></div>
        <div class="card"><h3>Elemento 4</h3><p>Sigue bajando...</p></div>
        <div class="card"><h3>Elemento 5</h3><p>M√°s contenido para scroll.</p></div>
        <div class="card"><h3>Elemento 6</h3><p>Fin del demo.</p></div>
    </div>

    <div id="canvas-container"></div>
    <video id="input_video" playsinline></video>

    <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        const hud = document.getElementById('hud');
        
        // --- THREE.JS CURSOR ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 5;
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const cursorGeo = new THREE.RingGeometry(0.06, 0.09, 32);
        const cursorMat = new THREE.MeshBasicMaterial({ color: 0x00ffcc, depthTest: false });
        const cursor = new THREE.Mesh(cursorGeo, cursorMat);
        scene.add(cursor);

        // --- L√ìGICA DE GESTOS ---
        let lastY = 0;
        let isPinching = false;
        let pinchStartTime = 0;
        let startScrollY = 0;
        let lastElement = null;

        function onResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const hand = results.multiHandLandmarks[0];
                const index = hand[8];
                const thumb = hand[4];
                const middle = hand[12];

                // Coordenadas
                const screenX = (1 - index.x) * window.innerWidth;
                const screenY = index.y * window.innerHeight;
                const threeX = (index.x - 0.5) * -11;
                const threeY = (index.y - 0.5) * -11;

                cursor.position.lerp(new THREE.Vector3(threeX, threeY, 0), 0.4);

                // Detecci√≥n de Pellizcos (Distancias)
                const distIndex = Math.hypot(index.x - thumb.x, index.y - thumb.y);
                const distMiddle = Math.hypot(middle.x - thumb.x, middle.y - thumb.y);

                const activePinch = distIndex < 0.06;
                const activeRightClick = distMiddle < 0.06;

                // Hover
                const el = document.elementFromPoint(screenX, screenY);
                if (el !== lastElement) {
                    if (lastElement) lastElement.classList.remove('hover');
                    if (el && el.closest('.card')) el.closest('.card').classList.add('hover');
                    lastElement = el;
                }

                // L√≥gica de Scroll y Click (Apple Style)
                if (activePinch) {
                    if (!isPinching) {
                        isPinching = true;
                        pinchStartTime = Date.now();
                        startScrollY = index.y;
                        lastY = index.y;
                        cursor.scale.set(0.7, 0.7, 1);
                        cursorMat.color.set(0xffff00); // Amarillo mientras mantienes
                    } else {
                        // Si se mantiene y se mueve -> SCROLL
                        const deltaY = (index.y - lastY) * 2000;
                        if (Math.abs(index.y - startScrollY) > 0.05) {
                            window.scrollBy(0, deltaY);
                            hud.innerText = "üìú SCROLLING";
                        }
                        lastY = index.y;
                    }
                } else {
                    if (isPinching) {
                        // Si solt√≥ r√°pido -> CLICK
                        const duration = Date.now() - pinchStartTime;
                        if (duration < 300) {
                            hud.innerText = "üëå CLICK IZQUIERDO";
                            if (el) el.click();
                        }
                        isPinching = false;
                        cursor.scale.set(1, 1, 1);
                        cursorMat.color.set(0x00ffcc);
                        hud.innerText = "üñêÔ∏è NAVEGANDO";
                    }
                }

                // Click Derecho
                if (activeRightClick) {
                    hud.innerText = "üñ±Ô∏è CLICK DERECHO";
                    cursorMat.color.set(0xff00ff);
                }
            }
        }

        // --- SETUP MEDIAPIPE ---
        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.8 });
        hands.onResults(onResults);

        const videoElement = document.getElementById('input_video');
        const cam = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });
        cam.start();

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
